<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Front Squat Biomechanical Analysis - Luca Lullo</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 16px;
      background: #000;
      color: #fff;
    }

    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }

    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      cursor: pointer;
    }

    button:disabled { opacity: .5; cursor: not-allowed; }

    .pill {
      padding: 6px 10px;
      border: 1px solid #333;
      border-radius: 999px;
      color: #00ff00;
    }

    #wrap { position: relative; width: min(900px, 100%); }

    video {
      width: 100%;
      height: auto;
      border-radius: 14px;
      border: 1px solid #222;
      background: #000;
    }

    canvas {
      width: 100%;
      height: auto;
      position: absolute;
      left: 0;
      top: 0;
      background: transparent;
      pointer-events: none;
    }

    #status { margin-top: 10px; font-size: 14px; color: #aaa; }
    #result { margin-top: 10px; font-size: 18px; font-weight: 600; }
    .muted { color: #aaa; }
  </style>
</head>

<body>

<p class="muted">Front Squat Biomechanical Analysis</p>
<h2>Luca Lullo</h2>

<div class="row">
  <button id="btnStart">Avvia camera</button>
  <button id="btnStop" disabled>Stop</button>
  <span class="pill" id="fps">FPS: -</span>
</div>

<div id="wrap" style="margin-top:12px;">
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>
</div>

<div id="status">Caricamento modello…</div>
<div id="result">—</div>

<script type="module">
import {
  FilesetResolver,
  PoseLandmarker,
  DrawingUtils
} from "https://esm.sh/@mediapipe/tasks-vision@latest";

/* ================= CONFIG ================= */

const MODEL_URL =
  "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task";

const WASM_URL =
  "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm";

// soglie biomeccaniche
const DESCENT_THRESHOLD = 0.002;
const ASCENT_THRESHOLD  = -0.002;
const SPEED_RATIO = 1.3;

// controllo temporale
const LOOP_INTERVAL = 40;       // 25 Hz
const ANALYSIS_INTERVAL = 200;

// anti-rumore / immobilità
const STILLNESS_THRESHOLD = 0.0005;
const STILLNESS_FRAMES = 15;
const MIN_DESCENT = 0.04;

// landmark
const L_SHOULDER = 11;
const L_HIP = 23;

/* ================= DOM ================= */

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusEl = document.getElementById("status");
const resultEl = document.getElementById("result");
const fpsEl = document.getElementById("fps");
const btnStart = document.getElementById("btnStart");
const btnStop = document.getElementById("btnStop");

/* ================= STATO ================= */

let landmarker;
let drawingUtils;
let running = false;
let lastTimeMs = 0;
let lastAnalysisTime = 0;
let frameCount = 0;
let fpsLastTs = performance.now();

let hipY = [];
let shoulderY = [];
let phase = "waiting";
let feedbackGiven = false;

let stillCounter = 0;
let startHipY = 0;
let maxHipY = 0;

/* ================= VOCE ================= */

function speak(text) {
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "it-IT";
  u.rate = 0.95;
  window.speechSynthesis.speak(u);
}

/* ================= UTILS ================= */

function resetBuffers() {
  hipY = [];
  shoulderY = [];
}

/* ================= ANALISI ================= */

function analyze() {
  const now = performance.now();
  if (now - lastAnalysisTime < ANALYSIS_INTERVAL) return;
  lastAnalysisTime = now;

  if (hipY.length < 3) return;

  const i = hipY.length - 1;
  const dyHip = hipY[i] - hipY[i - 1];
  const dyShoulder = shoulderY[i] - shoulderY[i - 1];

  // RILEVA IMMOBILITÀ
  if (Math.abs(dyHip) < STILLNESS_THRESHOLD) {
    stillCounter++;
  } else {
    stillCounter = 0;
  }
  if (stillCounter > STILLNESS_FRAMES) return;

  // INIZIO DISCESA
  if (phase === "waiting" && dyHip > DESCENT_THRESHOLD) {
    phase = "descending";
    startHipY = hipY[i];
    maxHipY = hipY[i];
  }

  // AGGIORNA PROFONDITÀ
  if (phase === "descending") {
    maxHipY = Math.max(maxHipY, hipY[i]);
  }

  // BOTTOM (solo se discesa sufficiente)
  if (
    phase === "descending" &&
    dyHip < 0 &&
    (maxHipY - startHipY) > MIN_DESCENT
  ) {
    phase = "bottom";
  }

  // INIZIO RISALITA → FEEDBACK
  if (phase === "bottom" && dyHip < ASCENT_THRESHOLD && !feedbackGiven) {
    phase = "ascending";
    feedbackGiven = true;

    const hipSpeed = Math.abs(dyHip);
    const shoulderSpeed = Math.abs(dyShoulder);

    if (hipSpeed > shoulderSpeed * SPEED_RATIO) {
      resultEl.textContent =
        "⚠️ Bacino sale prima: busto troppo in avanti";
      speak("Attenzione. Il bacino sale prima. Mantieni il petto più alto.");
    } else {
      resultEl.textContent = "✅ Risalita corretta";
      speak("Ottima ripetizione.");
    }
  }

  // FINE RIPETIZIONE → RESET
  if (phase === "ascending" && dyHip > 0) {
    phase = "waiting";
    feedbackGiven = false;
    stillCounter = 0;
    startHipY = 0;
    maxHipY = 0;
    resetBuffers();
  }
}

/* ================= DRAW ================= */

function draw(result) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!result?.landmarks?.length) return;

  const lm = result.landmarks[0];

  drawingUtils.drawLandmarks(lm, {
    radius: 3,
    color: "#00ff00"
  });

  drawingUtils.drawConnectors(lm, PoseLandmarker.POSE_CONNECTIONS, {
    color: "#00ff00",
    lineWidth: 3
  });
}

/* ================= LOOP ================= */

async function loop() {
  if (!running) return;

  const now = performance.now();
  if (now - lastTimeMs > LOOP_INTERVAL) {
    lastTimeMs = now;

    const res = landmarker.detectForVideo(video, now);
    draw(res);

    if (res?.landmarks?.length) {
      const lm = res.landmarks[0];
      hipY.push(lm[L_HIP].y);
      shoulderY.push(lm[L_SHOULDER].y);
    }

    analyze();
    frameCount++;
  }

  if (performance.now() - fpsLastTs > 1000) {
    fpsEl.textContent = "FPS: " + frameCount;
    frameCount = 0;
    fpsLastTs = performance.now();
  }

  requestAnimationFrame(loop);
}

/* ================= START / STOP ================= */

async function startCamera() {
  resetBuffers();
  phase = "waiting";
  feedbackGiven = false;
  stillCounter = 0;

  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" },
    audio: false
  });

  video.srcObject = stream;
  await video.play();

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  running = true;
  btnStart.disabled = true;
  btnStop.disabled = false;
  statusEl.textContent = "In esecuzione…";
  requestAnimationFrame(loop);
}

function stopCamera() {
  running = false;
  btnStart.disabled = false;
  btnStop.disabled = true;
  statusEl.textContent = "Fermato";
  video.srcObject?.getTracks().forEach(t => t.stop());
}

/* ================= INIT ================= */

btnStart.onclick = startCamera;
btnStop.onclick = stopCamera;

const vision = await FilesetResolver.forVisionTasks(WASM_URL);
landmarker = await PoseLandmarker.createFromOptions(vision, {
  baseOptions: { modelAssetPath: MODEL_URL, delegate: "GPU" },
  runningMode: "VIDEO",
  numPoses: 1
});

drawingUtils = new DrawingUtils(ctx);
statusEl.textContent = "Pronto. Premi Avvia camera.";

</script>
</body>
</html>